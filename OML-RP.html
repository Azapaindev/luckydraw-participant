<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ang Pao Lucky Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
html,body{margin:0;height:100%;font-family:system-ui;background:radial-gradient(circle at top,#ffcc4d,#7a0000);}
body.no-scroll{overflow:hidden;touch-action:none}
.card{width:320px;height:520px;border-radius:28px;background:linear-gradient(160deg,#b00000,#7a0000);box-shadow:0 0 25px rgba(255,204,77,.8),0 25px 70px rgba(0,0,0,.75);position:relative;overflow:hidden;}
.center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;}
.hidden{display:none}
#scratch{position:absolute;inset:0;z-index:5;touch-action:none}
#prizeLayer{position:absolute;inset:0;z-index:1}
#prizeLayer.big{transform:scale(1.25);text-shadow:0 0 18px rgba(255,215,0,.9);}
#inputLayer{position:absolute;inset:0;z-index:6;background-color:#D42D20;}
#progressText{position:absolute;bottom:12px;left:0;right:0;text-align:center;font-weight:bold;color:#FFD700;z-index:7;}
.firecracker{position:absolute;top:12px;width:64px;pointer-events:none;z-index:7;}
.firecracker.left{left:10px}
.firecracker.right{right:10px}
#lion{width:280px;margin-top:-20px;margin-bottom:10px;}
#prizeImg{width:200px;height:200px;object-fit:contain;object-position:center;background:transparent;border-radius:16px;margin:8px 0;}
#prizeText{font-weight:800;color:#fef08a;text-align:center;padding:0 12px;margin:8px auto 0;max-width:280px;word-break:break-word;overflow-wrap:break-word;hyphens:auto;line-height:1.3;}
#prizeText{font-size:1.375rem;}
#prizeText.long{font-size:1.2rem;line-height:1.28;}
#prizeText.very-long{font-size:1.05rem;line-height:1.25;}
@media (max-width:360px){#prizeText{font-size:1.125rem;}#prizeText.long,#prizeText.very-long{font-size:1rem;}}
#instructionText{transition:opacity 0.5s ease;}
</style>
</head>
<body class="flex items-center justify-center text-white">

<audio id="bgSound" preload="auto" loop playsinline>
  <source src="https://raw.githubusercontent.com/Azapaindev/luckydraw-participant/refs/heads/main/CNY%202026/viacheslavstarostin-chinese-lunar-new-year-465871.mp3" type="audio/mpeg">
</audio>

<div>
<h1 class="text-3xl font-extrabold text-center mb-6 text-yellow-300">ğŸ§§á¢á¶áŸ†á„á”áŸ‰á¶áœ á‚áŸ’ášá½áŸá¶áš ášáŸá“ á˜áŸ‰ášğŸ§§</h1>
<p id="instructionText" class="text-center text-yellow-200 mb-4 text-lg font-medium opacity-0 hidden">á€áŸ„áŸášá€á›á¶á”áŸáŸ†áá¶á„</p>

<div id="card" class="card">
  <div id="prizeLayer" class="center px-4">
    <h2 id="congratsText" class="text-lg font-semibold text-yellow-400 mb-1 hidden">Congratulations!</h2>
    <p id="winnerIdText" class="text-sm text-yellow-200 mb-1 hidden"></p>
    <img id="prizeImg" src="" alt="Prize">
    <p id="prizeText"></p>
  </div>
  <canvas id="scratch" class="hidden"></canvas>
  <div id="progressText" class="hidden">Luck Revealed: 0%</div>
  <div id="inputLayer" class="center px-6">
    <img class="firecracker left" src="https://i.pinimg.com/originals/f2/28/49/f22849aa488dfefce7ac2a17b5b4d0d9.gif">
    <img class="firecracker right" src="https://i.pinimg.com/originals/f2/28/49/f22849aa488dfefce7ac2a17b5b4d0d9.gif">
    <img id="lion" src="https://i.pinimg.com/originals/3f/c1/be/3fc1bef451c684ddcfb9f5bb98cd30f3.gif">
    <input id="userId" class="w-full p-3 rounded-full text-black text-center mb-4 font-semibold" placeholder="Enter your ID">
    <button id="openBtn" class="bg-yellow-400 text-black px-8 py-3 rounded-full font-extrabold text-lg">á…á»á…á”á¾á€á¢á¶áŸ†á„á”áŸ‰á¶áœ</button>
  </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, runTransaction, query, where, getDoc,
  arrayUnion
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAc53UEPP9_bz0W3iBmhghKROPL-FhsQCg",
  authDomain: "luckydraw-oml.firebaseapp.com",
  projectId: "luckydraw-oml"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const PLACEHOLDER_IMG = "https://png.pngtree.com/recommend-works/png-clipart/20250827/ourmid/pngtree-spring-festival-2026-year-of-the-horse-traditional-festival-golden-lunar-png-image_17142053.webp";

let prize = null;
let finished = false;
let currentUserId = "";
let isExistingWinner = false;
let isProcessing = false;

function normalizeId(raw) {
  const digits = String(raw).replace(/\D/g, '');
  if (digits.length === 0) return null;
  return digits.padStart(6, '0');
}

const audio = document.getElementById('bgSound');
function tryPlayAudio() { audio?.play().catch(() => {}); }
tryPlayAudio();
document.addEventListener('touchstart', tryPlayAudio, { once: true });
document.addEventListener('click', tryPlayAudio, { once: true });

document.getElementById("openBtn").onclick = async () => {
  if (isProcessing) return;

  let input = document.getElementById("userId").value.trim();
  if (!input) return alert("áŸá¼á˜á”á‰áŸ’á…á¼á› ID");

  const normalized = normalizeId(input);
  if (!normalized) return alert("ID á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœ â€“ áŸá¼á˜á”áŸ’ášá¾ááŸ‚á›áŸá");

  currentUserId = normalized;
  const openBtn = document.getElementById("openBtn");
  openBtn.disabled = true;
  openBtn.textContent = "á€áŸ†á–á»á„á–á·á“á·ááŸ’á™...";

  tryPlayAudio();

  const winnerSnap = await getDocs(
    query(collection(db, "winners"), where("userId", "==", normalized))
  );

  if (!winnerSnap.empty) {
    isExistingWinner = true;
    const win = winnerSnap.docs[0].data();
    if (win.prizeId) {
      const prizeRef = doc(db, "prizes", win.prizeId);
      const prizeSnap = await getDoc(prizeRef);
      if (prizeSnap.exists()) {
        prize = { id: win.prizeId, ...prizeSnap.data() };
        startScratch(win.companyId);
        return;
      }
    }
    alert("á¢áŸ’á“á€á’áŸ’á›á¶á”áŸ‹áˆáŸ’á“áŸ‡ášá½á…á á¾á™ á”áŸ‰á»á“áŸ’ááŸ‚á˜á·á“á¢á¶á…á•áŸ’á‘á»á€á–áŸááŸŒá˜á¶á“ášá„áŸ’áœá¶á“áŸ‹á”á¶á“á‘áŸáŸ”");
    resetButton();
    return;
  }

  const companySnap = await getDocs(collection(db, "companies"));
  let companyId = null;
  for (const docSnap of companySnap.docs) {
    const ids = docSnap.data().ids || [];
    if (ids.some(stored => normalizeId(stored) === normalized)) {
      companyId = docSnap.id;
      break;
    }
  }

  if (!companyId) {
    alert("á˜á·á“á˜á¶á“ ID á“áŸáŸ‡á“áŸ…á€áŸ’á“á»á„á”á‰áŸ’á‡á¸á€áŸ’ášá»á˜á áŸŠá»á“áá¶á˜á½á™á‘áŸ");
    resetButton();
    return;
  }

  const prizeSnap = await getDocs(collection(db, "prizes"));
  const available = prizeSnap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(p => p.companyId === companyId && (p.tickets?.length || 0) < p.count);

  if (available.length === 0) {
    alert("ášá„áŸ’áœá¶á“áŸ‹áŸá˜áŸ’ášá¶á”áŸ‹á€áŸ’ášá»á˜á áŸŠá»á“ášá”áŸáŸ‹á¢áŸ’á“á€á¢áŸáŸ‹ášá½á…á á¾á™áŸ”");
    resetButton();
    return;
  }

  prize = available[Math.floor(Math.random() * available.length)];
  startScratch(companyId);
};

function resetButton() {
  const btn = document.getElementById("openBtn");
  btn.disabled = false;
  btn.textContent = "á…á»á…á”á¾á€á¢á¶áŸ†á„á”áŸ‰á¶áœ";
}

function startScratch(companyId) {
  document.getElementById("prizeImg").src = PLACEHOLDER_IMG;
  document.getElementById("prizeText").textContent = "á€áŸ„áŸáŠá¾á˜áŸ’á”á¸á”á¾á€";

  const instr = document.getElementById("instructionText");
  instr.classList.remove("hidden");
  instr.style.opacity = "1";

  document.getElementById("inputLayer").classList.add("hidden");
  document.getElementById("scratch").classList.remove("hidden");
  document.getElementById("progressText").classList.remove("hidden");
  document.body.classList.add("no-scroll");

  initScratch(currentUserId, companyId);
}

function initScratch(uid, companyId) {
  const canvas = document.getElementById("scratch");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });

  canvas.width = document.getElementById("card").clientWidth;
  canvas.height = document.getElementById("card").clientHeight;

  ctx.fillStyle = "#d4af37";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.globalCompositeOperation = "destination-out";

  function draw(x, y) {
    ctx.beginPath();
    ctx.arc(x, y, 38, 0, Math.PI * 2);
    ctx.fill();
  }

  function getRevealedPercent() {
    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    let count = 0;
    for (let i = 3; i < data.length; i += 4) if (data[i] === 0) count++;
    return count / (data.length / 4);
  }

  const moveHandler = (e) => {
    if (finished || isProcessing) return;
    e.preventDefault();

    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

    draw(x, y);

    const percent = Math.floor(getRevealedPercent() * 100);
    document.getElementById("progressText").textContent = `Luck Revealed: ${percent}%`;

    if (percent >= 70) {
      finished = true;
      canvas.style.pointerEvents = "none";
      reveal(uid, companyId);
    }
  };

  canvas.onmousemove = moveHandler;
  canvas.ontouchmove = moveHandler;
}

async function reveal(uid, companyId) {
  if (isProcessing) return;
  isProcessing = true;

  if (isExistingWinner) {
    showWin(prize);
    isProcessing = false;
    return;
  }

  try {
    await runTransaction(db, async (tx) => {
      const prizeRef = doc(db, "prizes", prize.id);
      const snap = await tx.get(prizeRef);

      if (!snap.exists()) {
        throw new Error("ášá„áŸ’áœá¶á“áŸ‹á“áŸáŸ‡á›áŸ‚á„á˜á¶á“á‘áŸ€áá á¾á™");
      }

      const data = snap.data();
      const currentTickets = data.tickets || [];
      const currentCount = currentTickets.length;

      // Critical: enforce quantity limit inside transaction
      if (currentCount >= data.count) {
        throw new Error("ášá„áŸ’áœá¶á“áŸ‹á¢áŸáŸ‹ášá½á…á á¾á™ (á›á¾áŸá€á˜áŸ’ášá·áá€áŸ†áááŸ‹)");
      }

      if (currentTickets.includes(uid)) {
        throw new Error("á¢áŸ’á“á€á’áŸ’á›á¶á”áŸ‹á‘á¶á˜á‘á¶ášášá„áŸ’áœá¶á“áŸ‹á“áŸáŸ‡ášá½á…á á¾á™");
      }

      tx.update(prizeRef, {
        tickets: arrayUnion(uid)
      });

      await addDoc(collection(db, "winners"), {
        userId: uid,
        prizeId: prize.id,
        prizeName: prize.name,
        companyId,
        timestamp: Date.now()
      });
    });

    showWin(prize);
  } catch (err) {
    console.error("Reveal error:", err);

    let msg = "á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá‘á¶á˜á‘á¶ášášá„áŸ’áœá¶á“áŸ‹áŸ” áŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áá„á‘áŸ€ááŸ”";
    if (err.message?.includes("á¢áŸáŸ‹ášá½á…á á¾á™") || err.message?.includes("á›á¾áŸá€á˜áŸ’ášá·áá€áŸ†áááŸ‹")) {
      msg = "ášá„áŸ’áœá¶á“áŸ‹á“áŸáŸ‡á¢áŸáŸ‹ášá½á…á á¾á™ (á›á¾áŸá…áŸ†á“á½á“á€áŸ†áááŸ‹) â€“ áŸá¼á˜áŸá¶á€ášá„áŸ’áœá¶á“áŸ‹á•áŸ’áŸáŸá„!";
    } else if (err.message?.includes("á’áŸ’á›á¶á”áŸ‹á‘á¶á˜á‘á¶áš")) {
      msg = "á¢áŸ’á“á€á’áŸ’á›á¶á”áŸ‹áˆáŸ’á“áŸ‡ášá„áŸ’áœá¶á“áŸ‹á“áŸáŸ‡ášá½á…á á¾á™ (á”áŸ’ášá áŸ‚á›á‡á¶á”á¾á€á€áŸ’á“á»á„á‘á¶á”áŸ‹á•áŸ’áŸáŸá„)";
    }
    alert(msg);
    resetButton();
  } finally {
    isProcessing = false;
  }
}

function showWin(p) {
  document.getElementById("scratch").classList.add("hidden");
  document.getElementById("progressText").classList.add("hidden");
  document.body.classList.remove("no-scroll");

  const instr = document.getElementById("instructionText");
  instr.style.opacity = "0";
  setTimeout(() => instr.classList.add("hidden"), 500);

  document.getElementById("prizeImg").src = p.imageUrl || PLACEHOLDER_IMG;
  document.getElementById("prizeText").textContent = p.name;

  const len = p.name.length;
  const prizeTextEl = document.getElementById("prizeText");
  prizeTextEl.classList.remove("long", "very-long");
  if (len > 28) prizeTextEl.classList.add("very-long");
  else if (len > 20) prizeTextEl.classList.add("long");

  document.getElementById("congratsText").classList.remove("hidden");
  document.getElementById("winnerIdText").classList.remove("hidden");
  document.getElementById("winnerIdText").textContent = "ID: " + currentUserId;

  document.getElementById("prizeLayer").classList.add("big");

  confetti({
    particleCount: 200,
    spread: 140,
    origin: { y: 0.6 }
  });
}
</script>
</body>
</html>

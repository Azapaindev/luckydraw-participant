<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ang Pao Lucky Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
html,body{
  margin:0;height:100%;
  font-family:system-ui;
  background:radial-gradient(circle at top,#ffcc4d,#7a0000);
}
body.no-scroll{overflow:hidden;touch-action:none}
.card{
  width:320px;height:520px;
  border-radius:28px;
  background:linear-gradient(160deg,#b00000,#7a0000);
  box-shadow:0 0 25px rgba(255,204,77,.8),0 25px 70px rgba(0,0,0,.75);
  position:relative;
  overflow:hidden;
}
.center{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100%;
  text-align:center;
}
.hidden{display:none}
#scratch{position:absolute;inset:0;z-index:5;touch-action:none}
#prizeLayer{position:absolute;inset:0;z-index:1}
#prizeLayer.big{
  transform:scale(1.25);
  text-shadow:0 0 18px rgba(255,215,0,.9);
}
#inputLayer{
  position:absolute;
  inset:0;
  z-index:6;
  background-color:#D42D20;
}
#progressText{
  position:absolute;
  bottom:12px;
  left:0;right:0;
  text-align:center;
  font-weight:bold;
  color:#FFD700;
  z-index:7;
}
.firecracker{
  position:absolute;
  top:12px;
  width:64px;
  pointer-events:none;
  z-index:7;
}
.firecracker.left{left:10px}
.firecracker.right{right:10px}
#lion{
  width:280px;
  margin-top:-20px;
  margin-bottom:10px;
}
#prizeImg {
  width: 200px;
  height: 200px;
  object-fit: contain;
  object-position: center;
  background: transparent;
  border-radius: 16px;
  margin: 8px 0;
}

/* ── Prize name styling ──────────────────────────────────────── */
#prizeText {
  font-weight: 800;
  color: #fef08a;               /* yellow-200-ish */
  text-align: center;
  padding: 0 12px;
  margin: 8px auto 0;
  max-width: 280px;
  word-break: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
  line-height: 1.3;
}

/* Default size */
#prizeText {
  font-size: 1.375rem;          /* ~22px */
}

/* Medium-long names */
#prizeText.long {
  font-size: 1.2rem;            /* ~19px */
  line-height: 1.28;
}

/* Very long names */
#prizeText.very-long {
  font-size: 1.05rem;           /* ~16.8px */
  line-height: 1.25;
}

/* Extra safety for tiny screens */
@media (max-width: 360px) {
  #prizeText {
    font-size: 1.125rem;
  }
  #prizeText.long,
  #prizeText.very-long {
    font-size: 1rem;
  }
}
</style>
</head>
<body class="flex items-center justify-center text-white">

<audio id="bgSound" preload="auto" loop>
  <source src="https://nvc71330-my.sharepoint.com/personal/darith_rin_vital_com_kh/_layouts/15/stream.aspx?id=%2Fpersonal%2Fdarith%5Frin%5Fvital%5Fcom%5Fkh%2FDocuments%2Fcny%2Emp3" type="audio/mpeg">
</audio>

<div>
<h1 class="text-3xl font-extrabold text-center mb-1 text-yellow-300">
  Ang Pao Lucky Draw
</h1>
<p class="text-center text-yellow-200 mb-3">Scratch to reveal your luck</p>

<div id="card" class="card">
  <div id="prizeLayer" class="center px-4">
    <h2 id="congratsText"
        class="text-lg font-semibold text-yellow-400 mb-1 hidden">
      Congratulations!
    </h2>
    <p id="winnerIdText"
       class="text-sm text-yellow-200 mb-1 hidden"></p>
    <img id="prizeImg" src="" alt="Prize">
    <p id="prizeText"></p>
  </div>

  <canvas id="scratch" class="hidden"></canvas>

  <div id="progressText" class="hidden">Luck Revealed: 0%</div>

  <div id="inputLayer" class="center px-6">
    <img class="firecracker left"
      src="https://i.pinimg.com/originals/f2/28/49/f22849aa488dfefce7ac2a17b5b4d0d9.gif">
    <img class="firecracker right"
      src="https://i.pinimg.com/originals/f2/28/49/f22849aa488dfefce7ac2a17b5b4d0d9.gif">
    <img id="lion"
      src="https://i.pinimg.com/originals/3f/c1/be/3fc1bef451c684ddcfb9f5bb98cd30f3.gif">
    <input id="userId"
      class="w-full p-3 rounded-full text-black text-center mb-4 font-semibold"
      placeholder="Enter your ID">
    <button id="openBtn"
      class="bg-yellow-400 text-black px-8 py-3 rounded-full font-extrabold text-lg">
      Open Ang Pao
    </button>
  </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, runTransaction, query, where, getDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAc53UEPP9_bz0W3iBmhghKROPL-FhsQCg",
  authDomain: "luckydraw-oml.firebaseapp.com",
  projectId: "luckydraw-oml"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const PLACEHOLDER_IMG = "https://png.pngtree.com/recommend-works/png-clipart/20250827/ourmid/pngtree-spring-festival-2026-year-of-the-horse-traditional-festival-golden-lunar-png-image_17142053.webp";

let prize = null;
let finished = false;
let currentUserId = "";
let isExistingWinner = false;

function normalizeId(raw) {
  const digits = String(raw).replace(/\D/g, '');
  if (digits.length === 0) return null;
  return digits.padStart(6, '0');
}

/* MAIN */
openBtn.onclick = async () => {
  let input = userId.value.trim();
  if (!input) return alert("Please enter ID");

  const normalized = normalizeId(input);
  if (!normalized) return alert("Invalid ID – please use numbers only");

  currentUserId = normalized;
  openBtn.disabled = true;
  openBtn.textContent = "Checking...";

  const winnerSnap = await getDocs(
    query(collection(db, "winners"), where("userId", "==", normalized))
  );

  if (!winnerSnap.empty) {
    isExistingWinner = true;
    const win = winnerSnap.docs[0].data();

    if (win.prizeId) {
      const prizeRef = doc(db, "prizes", win.prizeId);
      const prizeSnap = await getDoc(prizeRef);
      if (prizeSnap.exists()) {
        prize = { id: win.prizeId, ...prizeSnap.data() };
        startScratch(win.companyId);
        return;
      }
    }

    alert("You already won, but prize details could not be loaded.");
    resetButton();
    return;
  }

  const companySnap = await getDocs(collection(db, "companies"));
  let companyId = null;

  for (const docSnap of companySnap.docs) {
    const ids = docSnap.data().ids || [];
    const match = ids.some(stored => normalizeId(stored) === normalized);
    if (match) {
      companyId = docSnap.id;
      break;
    }
  }

  if (!companyId) {
    alert("ID not found in any company list");
    resetButton();
    return;
  }

  const prizeSnap = await getDocs(collection(db, "prizes"));
  const available = prizeSnap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(p => p.companyId === companyId && (p.tickets?.length || 0) < p.count);

  if (available.length === 0) {
    alert("No more prizes available for your company.");
    resetButton();
    return;
  }

  prize = available[Math.floor(Math.random() * available.length)];
  startScratch(companyId);
};

function resetButton() {
  openBtn.disabled = false;
  openBtn.textContent = "Open Ang Pao";
}

/* SCRATCH */
function startScratch(companyId) {
  prizeImg.src = PLACEHOLDER_IMG;
  prizeText.textContent = "Scratch to reveal";
  inputLayer.classList.add("hidden");
  scratch.classList.remove("hidden");
  progressText.classList.remove("hidden");
  document.body.classList.add("no-scroll");

  initScratch(currentUserId, companyId);
}

function initScratch(uid, companyId) {
  const ctx = scratch.getContext("2d", { willReadFrequently: true });
  scratch.width = card.clientWidth;
  scratch.height = card.clientHeight;
  ctx.fillStyle = "#d4af37";
  ctx.fillRect(0, 0, scratch.width, scratch.height);
  ctx.globalCompositeOperation = "destination-out";

  function draw(x, y) {
    ctx.beginPath();
    ctx.arc(x, y, 38, 0, Math.PI * 2);
    ctx.fill();
  }

  function percent() {
    const d = ctx.getImageData(0, 0, scratch.width, scratch.height).data;
    let c = 0;
    for (let i = 3; i < d.length; i += 4) if (d[i] === 0) c++;
    return c / (d.length / 4);
  }

  scratch.onmousemove = scratch.ontouchmove = e => {
    if (finished) return;
    const r = scratch.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    draw(t.clientX - r.left, t.clientY - r.top);
    const p = Math.floor(percent() * 100);
    progressText.textContent = "Luck Revealed: " + p + "%";
    if (p >= 70) {
      finished = true;
      reveal(uid, companyId);
    }
  };
}

/* REVEAL */
async function reveal(uid, companyId) {
  if (isExistingWinner) {
    showWin(prize);
    return;
  }

  try {
    await runTransaction(db, async tx => {
      const ref = doc(db, "prizes", prize.id);
      const snap = await tx.get(ref);
      if (!snap.exists()) throw new Error("Prize disappeared");

      const tickets = snap.data().tickets || [];
      if (tickets.includes(uid)) throw new Error("Already taken");

      tickets.push(uid);
      tx.update(ref, { tickets });

      await addDoc(collection(db, "winners"), {
        userId: uid,
        prizeId: prize.id,
        prizeName: prize.name,
        companyId,
        timestamp: Date.now()
      });
    });

    showWin(prize);
  } catch (err) {
    console.error(err);
    alert("Sorry, there was a problem claiming your prize. Please try again or contact support.");
    resetButton();
  }
}

/* SHOW WIN */
function showWin(p) {
  scratch.classList.add("hidden");
  progressText.classList.add("hidden");
  document.body.classList.remove("no-scroll");

  prizeImg.src = p.imageUrl || PLACEHOLDER_IMG;

  // Set text and adjust size based on length
  prizeText.textContent = p.name;

  prizeText.classList.remove("long", "very-long");

  const len = p.name.length;
  if (len > 28) {
    prizeText.classList.add("very-long");
  } else if (len > 20) {
    prizeText.classList.add("long");
  }

  congratsText.classList.remove("hidden");
  winnerIdText.classList.remove("hidden");
  winnerIdText.textContent = "ID: " + currentUserId;

  prizeLayer.classList.add("big");

  confetti({
    particleCount: 200,
    spread: 140,
    origin: { y: 0.6 }
  });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ang Pao Lucky Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
html,body{
  margin:0;height:100%;
  font-family:system-ui;
  background:radial-gradient(circle at top,#ffcc4d,#7a0000);
}
body.no-scroll{overflow:hidden;touch-action:none}

/* CARD */
.card{
  width:320px;height:520px;
  border-radius:28px;
  background:linear-gradient(160deg,#b00000,#7a0000);
  box-shadow:0 0 25px rgba(255,204,77,.8),0 25px 70px rgba(0,0,0,.75);
  position:relative;
  overflow:hidden;
}

/* COMMON */
.center{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100%;
  text-align:center;
}
.hidden{display:none}

#scratch{position:absolute;inset:0;z-index:5;touch-action:none}

/* PRIZE */
#prizeLayer{position:absolute;inset:0;z-index:1}
#prizeLayer.big{
  transform:scale(1.45);
  text-shadow:0 0 18px rgba(255,215,0,.9);
}

/* INPUT */
#inputLayer{
  position:absolute;
  inset:0;
  z-index:6;
  background-color:#D42D20;
}

/* PROGRESS */
#progressText{
  position:absolute;
  bottom:12px;
  left:0;right:0;
  text-align:center;
  font-weight:bold;
  color:#FFD700;
  z-index:7;
}

/* FIRECRACKERS */
.firecracker{
  position:absolute;
  top:12px;
  width:64px;
  pointer-events:none;
  z-index:7;
}
.firecracker.left{left:10px}
.firecracker.right{right:10px}

/* LION */
#lion{
  width:280px;
  margin-top:-20px;
  margin-bottom:10px;
}
</style>
</head>

<body class="flex items-center justify-center text-white">

<div>
<h1 class="text-2xl font-extrabold text-center mb-1 text-yellow-300">üßß ÊÅ≠ÂñúÂèëË¥¢</h1>
<p class="text-center text-yellow-200 mb-3">Scratch to reveal your luck</p>

<div id="card" class="card">

<div id="prizeLayer" class="center px-4">
  <img id="prizeImg" class="w-48 mb-4">
  <p id="prizeText" class="text-3xl font-extrabold text-yellow-300"></p>
</div>

<canvas id="scratch" class="hidden"></canvas>
<div id="progressText" class="hidden">Luck Revealed: 0%</div>

<div id="inputLayer" class="center px-6">

  <img class="firecracker left"
    src="https://i.pinimg.com/originals/f2/28/49/f22849aa488dfefce7ac2a17b5b4d0d9.gif">
  <img class="firecracker right"
    src="https://i.pinimg.com/originals/f2/28/49/f22849aa488dfefce7ac2a17b5b4d0d9.gif">

  <img id="lion"
    src="https://i.pinimg.com/originals/3f/c1/be/3fc1bef451c684ddcfb9f5bb98cd30f3.gif"
    alt="Lion Dance">

  <input id="userId"
    class="w-full p-3 rounded-full text-black text-center mb-4 font-semibold"
    placeholder="Enter your ID">

  <button id="openBtn"
    class="bg-yellow-400 text-black px-8 py-3 rounded-full font-extrabold text-lg
           shadow-lg shadow-yellow-500/40">
    Open Ang Pao üßß
  </button>
</div>

</div>

<div id="afterWin" class="hidden mt-4 text-center">
  <button id="downloadBtn"
    class="bg-yellow-400 text-black px-6 py-2 rounded-full font-bold
           shadow-lg shadow-yellow-500/40">
    Download Winning Image üì•
  </button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  doc, runTransaction, query, where
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyAc53UEPP9_bz0W3iBmhghKROPL-FhsQCg",
  authDomain:"luckydraw-oml.firebaseapp.com",
  projectId:"luckydraw-oml"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const PLACEHOLDER_IMG="https://png.pngtree.com/recommend-works/png-clipart/20250827/ourmid/pngtree-spring-festival-2026-year-of-the-horse-traditional-festival-golden-lunar-png-image_17142053.webp";

let prize=null;
let finished=false;
let currentUserId="";

/* RESET */
function resetUI(msg){
  alert(msg);
  openBtn.disabled=false;
  openBtn.textContent="Open Ang Pao üßß";
}

/* MAIN */
openBtn.onclick=async()=>{
  const uidRaw = userId.value.trim();
  if(!uidRaw) return resetUI("Please enter ID");

  const uidNum = Number(uidRaw);   // üîë normalize input
  currentUserId = uidRaw;

  openBtn.disabled=true;
  openBtn.textContent="Checking Luck...";

  const winnerSnap=await getDocs(
    query(collection(db,"winners"), where("userId","==",uidRaw))
  );
  if(!winnerSnap.empty){
    const win=winnerSnap.docs[0].data();
    await loadExistingWin(win);
    return;
  }

  const companySnap=await getDocs(collection(db,"companies"));
  let companyId=null;

  companySnap.docs.forEach(d=>{
    (d.data().ids||[]).forEach(x=>{
      if(Number(x) === uidNum){   // ‚úÖ FIX HERE
        companyId=d.id;
      }
    });
  });

  if(!companyId) return resetUI("ID not found");

  const prizeSnap=await getDocs(collection(db,"prizes"));
  const available=prizeSnap.docs
    .map(d=>({id:d.id,...d.data()}))
    .filter(p=>p.companyId===companyId && (p.tickets?.length||0)<p.count);

  if(!available.length) return resetUI("No prizes available");

  prize=available[Math.floor(Math.random()*available.length)];

  prizeImg.src=PLACEHOLDER_IMG;
  prizeText.textContent="Scratch to reveal";

  inputLayer.classList.add("hidden");
  scratch.classList.remove("hidden");
  progressText.classList.remove("hidden");
  document.body.classList.add("no-scroll");

  initScratch(uidRaw,companyId);
};

/* SCRATCH */
function initScratch(uid,companyId){
  const ctx=scratch.getContext("2d",{willReadFrequently:true});
  scratch.width=card.clientWidth;
  scratch.height=card.clientHeight;

  ctx.fillStyle="#d4af37";
  ctx.fillRect(0,0,scratch.width,scratch.height);
  ctx.globalCompositeOperation="destination-out";

  function draw(x,y){
    ctx.beginPath();
    ctx.arc(x,y,38,0,Math.PI*2);
    ctx.fill();
  }

  function percent(){
    const d=ctx.getImageData(0,0,scratch.width,scratch.height).data;
    let c=0;
    for(let i=3;i<d.length;i+=4) if(d[i]===0) c++;
    return c/(d.length/4);
  }

  function move(e){
    e.preventDefault();
    if(finished) return;
    const r=scratch.getBoundingClientRect();
    const t=e.touches?e.touches[0]:e;
    draw(t.clientX-r.left,t.clientY-r.top);
    const p=Math.floor(percent()*100);
    progressText.textContent="Luck Revealed: "+p+"%";
    if(p>=70){
      finished=true;
      reveal(uid,companyId);
    }
  }

  scratch.addEventListener("mousemove",move);
  scratch.addEventListener("touchmove",move,{passive:false});
}

/* REVEAL */
async function reveal(uid,companyId){
  await runTransaction(db,async tx=>{
    const ref=doc(db,"prizes",prize.id);
    const snap=await tx.get(ref);
    const tickets=snap.data().tickets||[];
    tickets.push(uid);
    tx.update(ref,{tickets});
    await addDoc(collection(db,"winners"),{
      userId:uid,
      prizeId:prize.id,
      prizeName:prize.name,
      companyId,
      timestamp:Date.now()
    });
  });
  showWin(prize);
}

/* LOAD EXISTING */
async function loadExistingWin(win){
  const prizeSnap=await getDocs(collection(db,"prizes"));
  const p=prizeSnap.docs
    .map(d=>({id:d.id,...d.data()}))
    .find(x=>x.id===win.prizeId);
  if(p) showWin(p);
}

/* SHOW WIN */
function showWin(p){
  scratch.classList.add("hidden");
  progressText.classList.add("hidden");
  inputLayer.classList.add("hidden");
  document.body.classList.remove("no-scroll");

  prizeImg.src=p.imageUrl;
  prizeText.textContent=p.name;
  prizeLayer.classList.add("big");

  afterWin.classList.remove("hidden");

  confetti({
    particleCount:220,
    spread:140,
    colors:["#FFD700","#FFEC8B","#FFA500"],
    origin:{y:0.6}
  });
}

/* DOWNLOAD */
downloadBtn.onclick=async()=>{
  const canvas=await html2canvas(card,{scale:2});
  const link=document.createElement("a");
  link.download="ang-pao-"+currentUserId+".png";
  link.href=canvas.toDataURL("image/png");
  link.click();
};
</script>
</body>
</html>

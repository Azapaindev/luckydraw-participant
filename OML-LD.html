<!DOCTYPE html>
<html lang="kh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Draw Participant</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
@keyframes shake {0% {transform: translateX(0);} 25% {transform: translateX(-5px);} 50% {transform: translateX(5px);} 75% {transform: translateX(-5px);} 100% {transform: translateX(0);}}
.shake {animation: shake 0.5s;}
.glow {text-shadow: 0 0 8px #3b82f6, 0 0 12px #3b82f6;} /* blue glow */
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAc53UEPP9_bz0W3iBmhghKROPL-FhsQCg",
  authDomain: "luckydraw-oml.firebaseapp.com",
  projectId: "luckydraw-oml",
  storageBucket: "luckydraw-oml.firebasestorage.app",
  messagingSenderId: "147642717383",
  appId: "1:147642717383:web:a6c3663bed4c0dede25ae2",
  measurementId: "G-MKN8QVYDYD"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let prizes = [];

// ---------------- Lucky Draw ----------------
onSnapshot(collection(db, 'prizes'), snapshot => {
  prizes = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  renderWinningList();
});

function checkWinner() {
  const num = document.getElementById('participantNumber').value.trim();
  const resultEl = document.getElementById('result');
  resultEl.classList.remove('shake', 'glow');
  if (!num) { resultEl.innerHTML = ''; return; }

  let found = false, prizeName = '';
  for (const prize of prizes) {
    if (prize.tickets && prize.tickets.includes(num)) {
      found = true; prizeName = prize.name; break;
    }
  }

  if (found) {
    resultEl.innerHTML = `<span class='text-blue-600 text-2xl font-bold'>🎉 អបអរសាទរ! អ្នកឈ្នះ: <b>${prizeName}</b></span>`;
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#3b82f6','#60a5fa','#93c5fd'] });
  } else {
    resultEl.innerHTML = `<span class='text-gray-700 text-xl'>មិនមានរង្វាន់ឈ្នះនៅឡើយទេ។</span>`;
    resultEl.classList.add('shake','glow');
  }
}

function renderWinningList() {
  const listEl = document.getElementById('winningList');
  listEl.innerHTML = '';
  const grouped = {};
  prizes.forEach(prize => {
    if (prize.tickets && prize.tickets.length > 0) grouped[prize.name] = prize.tickets;
  });
  for (const [prizeName, tickets] of Object.entries(grouped)) {
    const div = document.createElement('div');
    div.className = 'mb-4';
    const h = document.createElement('h3');
    h.className = 'text-lg font-bold text-blue-600 mb-2';
    h.textContent = `រង្វាន់: ${prizeName}`;
    div.appendChild(h);
    const ul = document.createElement('ul');
    ul.className = 'pl-4';
    tickets.forEach(t => {
      const li = document.createElement('li');
      li.className = 'mb-1 p-1 border rounded bg-blue-50';
      li.textContent = `លេខសន្លឹកឆ្នោត: ${t}`;
      ul.appendChild(li);
    });
    div.appendChild(ul);
    listEl.appendChild(div);
  }
}

// ---------------- Staff lookup ----------------
function normalizeId(raw) {
  if (!raw) return null;
  const digits = (''+raw).replace(/\D/g,'');
  if (digits==='') return null;
  return String(parseInt(digits,10));
}

async function lookupStaff() {
  const raw = document.getElementById('staffIdInput').value.trim();
  const resultArea = document.getElementById('staffResult');
  resultArea.innerHTML = '';
  if (!raw) return;

  const normalized = normalizeId(raw) || raw;
  try {
    const snap = await getDoc(doc(db,'staffs',normalized));
    if (snap.exists()) return renderStaffData(snap.data());
    const snap2 = await getDoc(doc(db,'staffs',raw));
    if (snap2.exists()) return renderStaffData(snap2.data());
    resultArea.innerHTML = `<div class="text-sm text-red-600">រកមិនឃើញព័ត៌មានសម្រាប់ "${raw}"</div>`;
  } catch (err) {
    resultArea.innerHTML = `<div class="text-sm text-red-600">បរាជ័យក្នុងការស្វែងរក: ${err.message}</div>`;
  }
}

function renderStaffData(data) {
  const resultArea = document.getElementById('staffResult');
  const name = escapeHtml(data.fullName||'');
  const grp = escapeHtml(data.group||'');
  const bus = escapeHtml(data.bus||'');
  const location = escapeHtml(data.location||'');
  const hotel = escapeHtml(data.hotel||'');
  const room = escapeHtml(data.roomNumber||'');
  const roles = escapeHtml(data.roles||'');
  const telegram = data.telegramLink || '';

  let html = `<div class="p-4 border rounded bg-white shadow-sm">`;
  html += `<div class="text-lg font-bold mb-2">ឈ្មោះ: ${name}</div>`;
  html += `<div class="grid grid-cols-1 gap-1 text-sm mb-2">`;
  html += `<div>វេន: ${grp||'-'}</div>`;
  html += `<div>លេខឡានៈ  ${bus||'-'}</div>`;
  html += `<div>ទីតាំងឡើងឡានៈ ${location||'-'}</div>`;
  html += `<div>ម៉ោងឡើងឡានៈ 4:30 ព្រឹក</div>`;
  html += `<div>សណ្ឋាគារៈ ${hotel||'-'}</div>`;
  html += `<div>លេខបន្ទប់ៈ ${room||'-'}</div>`;
  html += `</div>`;
  if (roles) html += `<div class="mb-2"><b>Roles:</b> ${roles}</div>`;
  if (telegram) {
    html += `<div class="mt-2"><a href="${escapeHtml(telegram)}" target="_blank" class="inline-block px-3 py-2 bg-blue-600 text-white rounded">ចុចចូលគ្រុបតេលេក្រាម</a></div>`;
  }
  html += `</div>`;
  resultArea.innerHTML = html;
}

function escapeHtml(s){return String(s||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

// Auto-check inputs
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('participantNumber').addEventListener('input',checkWinner);
  document.getElementById('staffIdInput').addEventListener('input',()=>{
    clearTimeout(window._staffTimer);
    window._staffTimer=setTimeout(lookupStaff,400);
  });
});
</script>
</head>

<body class="bg-gradient-to-br from-blue-500 to-blue-300 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-extrabold text-blue-600 mb-6 text-center animate-bounce">ដំណើរកំសាន្តគ្រួសារ OML 2025</h1>
    <h1 class="text-2xl font-extrabold text-blue-600 mb-6 text-center animate-bounce">"កម្លាំងមហាសាគរ"</h1>

    <!-- Tabs -->
    <div class="flex mb-4 justify-center space-x-2">
      <button onclick="showTab('staff')" class="tabBtn bg-blue-600 text-white px-4 py-2 rounded">ព័ត៌មានដំណើរកំសាន្ត</button>
      <button onclick="showTab('all')" class="tabBtn bg-gray-300 text-gray-700 px-4 py-2 rounded">ព័ត៌មានអ្នកឈ្នះរង្វាន់</button>
    </div>

    <!-- Staff Info -->
    <div id="tab-staff">
      <div class="mb-3">
        <input id="staffIdInput" type="text" placeholder="បញ្ចូលលេខបុគ្គលិក (ឧ. 000168 ឬ 168)" class="w-full border rounded-lg p-3"/>
      </div>
      <div id="staffResult"></div>
    </div>

    <!-- All Tickets -->
    <div id="tab-all" class="hidden space-y-6">
      <div class="space-y-3">
        <input id="participantNumber" type="text" placeholder="បញ្ចូលលេខសន្លឹកឆ្នោត" class="w-full border rounded-lg p-4 text-center"/>
        <p id="result" class="mt-2 font-bold text-center text-xl"></p>
      </div>

      <div class="max-h-96 overflow-y-auto p-4 border rounded bg-blue-50">
        <p class="mb-3 text-sm text-blue-700">
          ខាងក្រោមជាព័ត៌មានអ្នកឈ្នះរង្វាន់ ក្នុងកម្មវិធីដំណើរកំសាន្តគ្រួសារ OML 2025:
        </p>
        <ul id="winningList" class="space-y-2"></ul>
      </div>
    </div>
  </div>

<script>
function showTab(tab){
  document.getElementById('tab-staff').classList.toggle('hidden', tab!=='staff');
  document.getElementById('tab-all').classList.toggle('hidden', tab!=='all');
  
  document.querySelectorAll('.tabBtn').forEach(btn=>{
    btn.classList.remove('bg-blue-600','text-white');
    btn.classList.add('bg-gray-300','text-gray-700');
  });

  if(tab==='staff') document.querySelectorAll('.tabBtn')[0].classList.add('bg-blue-600','text-white');
  else document.querySelectorAll('.tabBtn')[1].classList.add('bg-blue-600','text-white');
}

showTab('staff'); // default first tab
</script>
</body>
</html>
